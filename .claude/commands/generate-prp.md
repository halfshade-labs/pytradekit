# 创建PRP（基于对话上下文）

## 对话上下文驱动的PRP生成

基于当前对话历史理解需求，生成功能实现的完整PRP。无需提供功能文件参数，系统会自动分析对话内容、研究代码库并生成针对性PRP。

**工作流程：**
1. **需求确认**：通过对话明确功能需求和约束
2. **上下文分析**：自动分析代码库寻找相关模式
3. **智能生成**：基于对话历史和代码库上下文生成PRP
4. **验证循环**：提供可执行的验证步骤确保质量

**使用方法：**
- 直接在对话中描述需求
- 系统会询问必要的澄清问题
- 确认后自动生成完整PRP

**对话历史分析能力：**
- 自动提取功能目标
- 识别技术约束和集成需求
- 理解业务价值和用户场景
- 发现潜在的实现难点

AI agent 只能获得你附加到PRP的上下文和训练数据。假设AI agent可以访问代码库，并拥有与你相同的知识截止时间，因此你的研究结果必须包含或引用在PRP中。agent具有网络搜索功能，因此请传递文档和示例的URL。

## 智能需求分析与上下文提取

### 1. 对话历史分析
自动分析当前对话上下文，提取：
- **功能目标**：用户想要实现的核心功能
- **业务背景**：为什么需要这个功能
- **技术约束**：性能、兼容性、集成需求
- **用户场景**：具体的使用场景和期望行为

### 2. 代码库智能扫描
基于提取的需求，自动：
- **模式识别**：寻找类似的实现模式
- **文件定位**：识别相关的核心文件和模块
- **约定检测**：发现项目特定的编码规范
- **集成点分析**：找到最佳的集成位置

### 3. 需求澄清（如需要）
如果对话历史信息不足，系统会主动询问：
- 功能的具体范围和边界
- 性能要求和约束条件
- 与现有功能的集成需求
- 优先级和交付时间要求

### 4. 上下文整合
将以下信息整合到PRP中：
- **对话中的关键需求点**
- **代码库中的相关模式**
- **项目特定的最佳实践**
- **潜在的技术挑战和解决方案**

## PRP生成

使用PRPs/templates/prp_base.md作为模板：

### 基于对话的智能上下文构建
系统将自动：

1. **从对话中提取关键信息**:
   - 功能描述和期望行为
   - 技术要求和约束
   - 集成需求和依赖关系
   - 优先级和时间线

2. **代码库相关模式识别**:
   - 自动搜索类似功能实现
   - 提取相关文件路径和代码片段
   - 识别项目特定的设计模式
   - 发现最佳实践和约定

3. **上下文丰富化**:
   - **文档**: 基于需求自动查找相关文档URL
   - **代码示例**: 从代码库中提取最相关的实现示例
   - **陷阱**: 基于项目经验识别潜在问题
   - **模式**: 自动推荐符合项目规范的设计模式

### 上下文质量保证
- **信息完整性**: 确保所有必要上下文都被捕获
- **相关性验证**: 确保提供的上下文与需求高度相关
- **可执行性检查**: 验证所有示例和验证步骤可实际执行

### 智能实施蓝图生成
基于对话上下文和代码库分析，自动生成：

1. **渐进式任务分解**:
   - **任务识别**: 基于需求复杂度自动分解任务
   - **依赖分析**: 识别任务间的依赖关系
   - **优先级排序**: 按逻辑依赖和重要性排序
   - **可验证里程碑**: 每个任务都有明确的完成标准

2. **模式匹配实施路径**:
   - **代码模板**: 基于项目现有模式生成代码框架
   - **文件定位**: 智能推荐文件创建/修改位置
   - **命名规范**: 遵循项目命名约定
   - **集成点**: 明确与现有系统的集成方式

3. **错误处理策略**:
   - **异常类型**: 基于项目异常体系推荐处理方式
   - **重试机制**: 使用项目现有的重试装饰器模式
   - **日志规范**: 遵循结构化日志格式
   - **用户反馈**: 提供清晰的错误信息和建议

4. **任务执行清单**:
   ```yaml
   任务1 - 基础框架创建:
     操作: 创建/修改核心文件
     验证: 语法检查通过，基本结构正确
     
   任务2 - 核心逻辑实现:
     操作: 实现主要功能逻辑
     验证: 单元测试通过，边界情况处理
     
   任务3 - 集成与适配:
     操作: 与现有系统集成
     验证: 集成测试通过，无回归问题
     
   任务4 - 验证与优化:
     操作: 性能优化和最终验证
     验证: 所有测试通过，性能达标
   ```

### 智能验证循环
基于对话上下文和项目特点，自动生成可执行的验证步骤：

#### 第1级: 即时验证
```bash
# 语法和样式检查 - 自动适配项目配置
ruff check src/ --fix
mypy src/ --ignore-missing-imports

# 期望输出: 无错误或自动修复
# 如果有错误: 根据错误信息修复代码
```

#### 第2级: 单元测试驱动
```bash
# 基于需求生成针对性测试
# 测试文件: tests/test_[feature_name].py

# 运行新生成的测试
pytest tests/test_[feature_name].py -v

# 迭代修复直到通过
# 每修复一个错误就重新运行测试
```

#### 第3级: 集成验证
```bash
# 完整测试套件验证
pytest tests/ -v --tb=short

# 项目特定验证命令
# 根据项目配置自动发现
```

#### 第4级: 运行时验证
```bash
# 启动开发服务器
python -m [项目启动模块] --dev

# 手动验证关键路径
# 基于功能需求生成具体的curl命令或测试脚本
```

## 使用示例工作流程

### 步骤1: 需求讨论
用户: "我想添加一个实时价格监控功能，当价格波动超过阈值时发送通知"

### 步骤2: 需求澄清
系统: "让我确认一下需求：
- 监控哪些交易对的实时价格？
- 价格波动阈值是多少？
- 通知方式是什么（Slack/邮件/其他）？
- 需要存储历史数据吗？"

### 步骤3: 上下文分析和PRP生成
系统: 基于对话自动分析代码库，提取相关模式，生成完整PRP

### 步骤4: 验证和执行
按照生成的验证循环逐步执行，确保质量

*** 重要提示: 在生成PRP之前，确保已充分理解需求并完成代码库分析 ***

*** 开始实施前，请确认所有需求已被正确理解 ***

## 智能输出和质量保证

### 自动化输出
- **文件名**: `PRPs/YYYYMMDD-[功能名称]-[对话摘要].md`
- **命名规则**: 基于对话内容自动生成描述性文件名
- **版本管理**: 支持迭代更新和版本追踪

### 智能质量评估
系统自动进行多维度质量评分：

#### 上下文完整性评分 (1-10)
- **需求理解准确性**: 是否准确捕捉对话中的核心需求
- **代码库相关性**: 引用的模式是否与当前项目高度相关
- **技术约束覆盖**: 是否考虑了所有技术和业务约束

#### 可执行性评分 (1-10)
- **验证步骤可行性**: 所有验证命令是否可在项目中执行
- **代码示例准确性**: 引用的文件和代码片段是否准确
- **依赖关系清晰度**: 是否清晰说明了所有依赖和前提条件

#### 实施成功率预测 (1-10)
- **模式匹配度**: 推荐的实现模式与项目规范的匹配程度
- **风险识别**: 是否提前识别了潜在的技术风险
- **迭代友好性**: 是否支持渐进式开发和快速验证

### 质量检查清单（自动验证）
- [ ] **需求理解**: 对话中的核心需求被准确识别
- [ ] **上下文完整**: 包含所有必要的代码库上下文
- [ ] **模式匹配**: 推荐的实现符合项目现有模式
- [ ] **验证可行**: 所有验证步骤可在当前环境中执行
- [ ] **错误处理**: 包含全面的错误处理和边界情况
- [ ] **集成清晰**: 明确说明与现有系统的集成点
- [ ] **测试覆盖**: 提供完整的测试策略和验证步骤

### 最终质量评分
系统会基于以上维度给出综合评分（1-10），并提供改进建议：
- **9-10分**: 极高置信度，一次通过实施
- **7-8分**: 高置信度，少量调整可能需要
- **5-6分**: 中等置信度，需要额外澄清或调整
- **1-4分**: 低置信度，需要重新评估需求或设计

记住：目标是通过对话上下文的深度理解和智能分析，实现一次通过的实施成功。