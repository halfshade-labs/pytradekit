# 分支差异审查

分析当前分支与主分支（main）的代码差异，用于提PR或检查PR时使用。

## 工作流程

1. **获取分支信息**
   - 使用 `git branch --show-current` 获取当前分支名
   - 使用 `git log --oneline main..HEAD` 获取提交记录列表
   - 使用 `git log --stat main..HEAD` 获取提交统计信息

2. **获取提交详情**
   - 使用 `git log main..HEAD` 获取完整的提交信息和差异
   - 使用 `git diff --stat main..HEAD` 获取文件变更统计
   - 使用 `git diff --name-status main..HEAD` 获取文件变更列表

3. **分析代码变更**
   - 通过提交记录理解每次提交的目的和变更内容
   - 识别新增、修改、删除的文件
   - 分析每个文件的变更内容
   - 识别新增的功能、函数、类

4. **检查代码规范**
   根据项目的编码规范（参考 repo_specific_rule）检查：
   - **函数命名**：是否使用小写字母+下划线（snake_case）
   - **类命名**：是否使用驼峰命名法（PascalCase）
   - **函数长度**：是否超过合理长度，是否需要拆分
   - **文件长度**：是否过长，是否需要拆分到 utils/tools.py
   - **类型定义**：枚举类型是否统一使用 Enum，存放在 utils/types.py
   - **日志使用**：是否只使用 debug 和 info，重要信息使用 info
   - **字符串格式**：是否统一使用 f-string
   - **异常处理**：是否使用 pytradekit 的异常处理方式
   - **测试**：是否有对应的测试文件（tests/test_*.py）
   - **导入**：是否优先使用 pytradekit 里的方法

5. **识别问题和优化点**
   - **错误问题**：违反编码规范、可能导致bug的问题
   - **警告问题**：代码质量问题、潜在的性能问题
   - **优化建议**：可以改进的地方，如代码重复、可读性等

6. **生成总结报告**
   按照以下格式生成报告：

## 报告格式

```
================================================================================
分支差异审查报告
================================================================================
当前分支: {branch_name}
对比分支: {base_branch}
变更文件数: {total_files}
新增行数: +{additions}
删除行数: -{deletions}

📋 功能变更:
  • {功能1描述}
  • {功能2描述}
  ...

📁 文件变更详情:
  [ADDED] {文件路径}
  [MODIFIED] {文件路径}
  [DELETED] {文件路径}
  ...

❌ 错误问题:
  • {文件路径}:{行号} - {问题描述}
    {代码片段}
  ...

⚠️  警告问题:
  • {文件路径}:{行号} - {问题描述}
    {代码片段}
  ...

💡 优化建议:
  • {文件路径}:{行号} - {建议描述}
    {代码片段}
  ...

✨ 可优化点:
  • {优化建议1}
  • {优化建议2}
  ...

================================================================================
总体评价
================================================================================
{总体评价文字}

符合规范程度: {评分}/10
```

## 分析重点

### 1. 功能识别
- 通过文件路径和函数名识别新增功能
- 分析函数和类的用途
- 识别是否与现有功能重复

### 2. 规范检查
重点关注：
- 函数名是否符合 snake_case
- 类名是否符合 PascalCase
- 是否遵循 DRY、KISS、YAGNI、SOLID 原则
- 是否优先使用 pytradekit 的方法
- 类型定义是否在 utils/types.py
- 日志是否使用 f-string 和正确的级别

### 3. 问题识别
- 硬编码值
- 缺少异常处理
- 缺少类型注解
- 代码重复
- 过长的函数
- 缺少测试

### 4. 优化建议
- 代码结构优化
- 性能优化
- 可读性改进
- 测试覆盖

## 执行步骤

1. 运行 `git log --oneline main..HEAD` 获取提交记录列表
2. 运行 `git log --stat main..HEAD` 获取提交统计信息
3. 运行 `git diff --stat main..HEAD` 获取文件变更统计
4. 运行 `git diff --name-status main..HEAD` 获取文件变更列表
5. 运行 `git log main..HEAD` 获取完整的提交信息和代码差异
6. 分析每个提交的目的和变更内容，检查规范
7. 生成完整的文字报告

## 注意事项

- 主分支固定为 main
- 只分析 Python 文件（.py）
- 重点关注新增和修改的代码
- 忽略删除的代码（除非删除有问题）
- 对于大文件，重点分析关键函数和类的变更
- 通过提交记录理解变更的上下文和目的

